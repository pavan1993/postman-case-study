name: Ingest Refund API into Postman (Mock + Real Canonicals)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "payment-refund-api-openapi.yaml"
      - "scripts/**"
      - ".github/workflows/ingest.yml"

concurrency:
  group: postman-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Init + install deps
        run: |
          npm init -y
          node -e "const fs=require('fs');const p=require('./package.json');p.type='module';fs.writeFileSync('package.json', JSON.stringify(p,null,2));"
          npm i node-fetch@3

      - name: Remove previous artifacts
        run: rm -rf artifacts && mkdir -p artifacts

      - name: Run ingestion (spec -> generated collection JSON)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        run: node scripts/ingest.js

      - name: Patch generated collection into two variants (Mock + Real)
        env:
          POSTMAN_SERVICE_KEY: ${{ secrets.POSTMAN_SERVICE_KEY }}
        run: node scripts/patch_collection.js

      - name: Install Newman
        run: npm install newman

      - name: Start mock server
        run: |
          nohup node scripts/mock_server.js > /tmp/mock_server.log 2>&1 &
          echo $! > /tmp/mock_pid
          sleep 1

      - name: Run Newman tests
        run: |
          npx newman run artifacts/collection.jwt_mock.json \
            --environment newman/env.ci.local.json \
            --delay-request 50 \
            --reporters cli,junit \
            --reporter-junit-export artifacts/newman-junit.xml

      - name: Stop mock server
        if: always()
        run: |
          if [ -f /tmp/mock_pid ]; then
            kill "$(cat /tmp/mock_pid)" || true
          fi

      - name: Upsert JWT Mock collection into workspace
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_COLLECTION_FILE: artifacts/collection.jwt_mock.json
          POSTMAN_COLLECTION_NAME: ${{ format('Payments / {0} (JWT Mock)', secrets.POSTMAN_SERVICE_KEY) }}
          POSTMAN_DEBUG: ${{ vars.POSTMAN_DEBUG }}
        run: node scripts/upsert_collection.js

      - name: Small delay to avoid Postman burst limits
        run: sleep 3

      - name: Upsert OAuth2 Ready collection into workspace
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_COLLECTION_FILE: artifacts/collection.oauth2_ready.json
          POSTMAN_COLLECTION_NAME: ${{ format('Payments / {0} (OAuth2 Ready)', secrets.POSTMAN_SERVICE_KEY) }}
          POSTMAN_DEBUG: ${{ vars.POSTMAN_DEBUG }}
        run: node scripts/upsert_collection.js

      - name: Upsert environments (Dev/QA/UAT/Prod) into Postman (no duplicates)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_SERVICE_KEY: ${{ secrets.POSTMAN_SERVICE_KEY }}
        run: node scripts/upsert_envs.js

      - name: Delete auto-generated collection (cleanup)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        run: node scripts/delete_generated_collection.js

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: postman-artifacts
          path: artifacts/

      - name: Governance note
        if: always()
        run: |
          echo "Governance: publishing on main. Retention policy: keep last 5 versioned builds per collection (cleanup via scheduled job)."
