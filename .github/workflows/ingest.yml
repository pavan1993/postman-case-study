name: Ingest Refund API into Postman (Mock + Real Canonicals)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "payment-refund-api-openapi.yaml"
      - "scripts/**"
      - ".github/workflows/ingest.yml"

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Init + install deps
        run: |
          npm init -y
          node -e "const fs=require('fs');const p=require('./package.json');p.type='module';fs.writeFileSync('package.json', JSON.stringify(p,null,2));"
          npm i node-fetch@3

      - name: Run ingestion (spec -> generated collection JSON)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        run: node scripts/ingest.js

      - name: Patch generated collection into two variants (Mock + Real)
        env:
          POSTMAN_SERVICE_KEY: ${{ secrets.POSTMAN_SERVICE_KEY }}
        run: node scripts/patch_collection.js

      - name: Upsert JWT Mock collection into workspace
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_COLLECTION_FILE: artifacts/collection.jwt_mock.json
          POSTMAN_COLLECTION_NAME: ${{ format('Payments / {0} (JWT Mock)', secrets.POSTMAN_SERVICE_KEY) }}
        run: node scripts/upsert_collection.js

      - name: Small delay to avoid Postman burst limits
        run: sleep 3

      - name: Upsert OAuth2 Ready collection into workspace
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_COLLECTION_FILE: artifacts/collection.oauth2_ready.json
          POSTMAN_COLLECTION_NAME: ${{ format('Payments / {0} (OAuth2 Ready)', secrets.POSTMAN_SERVICE_KEY) }}
        run: node scripts/upsert_collection.js

      - name: Upsert environments (Dev/QA/UAT/Prod) into Postman (no duplicates)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_SERVICE_KEY: ${{ secrets.POSTMAN_SERVICE_KEY }}
        run: node scripts/upsert_envs.js

      - name: Delete auto-generated collection (cleanup)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        run: node scripts/delete_generated_collection.js

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: postman-artifacts
          path: artifacts/
